#!/usr/bin/env php
<?php
/**
 * Sistema de Migraciones de Musedock
 * Similar a Laravel Migrations
 *
 * Uso:
 *   php migrate                    # Ejecutar migraciones pendientes
 *   php migrate status             # Ver estado de migraciones
 *   php migrate rollback           # Revertir última batch
 *   php migrate fresh              # Recrear todo
 *   php migrate --module=nombre    # Migrar solo un módulo
 */

define('APP_ROOT', __DIR__);

// Cargar autoloader
require_once APP_ROOT . '/vendor/autoload.php';

// Cargar variables de entorno
$envFile = APP_ROOT . '/.env';
if (file_exists($envFile)) {
    $lines = file($envFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    foreach ($lines as $line) {
        // Ignorar comentarios
        if (strpos(trim($line), '#') === 0) {
            continue;
        }

        // Parsear línea
        $parts = explode('=', $line, 2);
        if (count($parts) === 2) {
            $key = trim($parts[0]);
            $value = trim($parts[1]);

            // Remover comillas
            $value = trim($value, '"\'');

            putenv("{$key}={$value}");
            $_ENV[$key] = $value;
        }
    }
}

use Screenart\Musedock\Database\MigrationManager;

// Colores para terminal
class Colors {
    const RESET = "\033[0m";
    const BOLD = "\033[1m";
    const GREEN = "\033[32m";
    const RED = "\033[31m";
    const YELLOW = "\033[33m";
    const BLUE = "\033[34m";
    const CYAN = "\033[36m";
}

// Banner
function showBanner() {
    echo Colors::CYAN . Colors::BOLD;
    echo "\n";
    echo "╔═══════════════════════════════════════════════════╗\n";
    echo "║   Musedock Migration System                       ║\n";
    echo "║   Laravel-style Database Migrations               ║\n";
    echo "╚═══════════════════════════════════════════════════╝\n";
    echo Colors::RESET . "\n";
}

// Configuración de base de datos desde .env
function getDatabaseConfig(): array {
    $driver = getenv('DB_DRIVER') ?: getenv('DB_CONNECTION') ?: 'mysql';
    $host = getenv('DB_HOST') ?: 'localhost';
    $port = getenv('DB_PORT') ?: ($driver === 'pgsql' ? '5432' : '3306');
    $database = getenv('DB_DATABASE') ?: getenv('DB_NAME');
    $username = getenv('DB_USERNAME') ?: getenv('DB_USER') ?: 'root';
    $password = getenv('DB_PASSWORD') ?: getenv('DB_PASS') ?: '';

    if (empty($database)) {
        echo Colors::RED . "Error: No se pudo leer la configuración de la base de datos desde .env\n" . Colors::RESET;
        echo "Asegúrate de que exista el archivo .env con las variables DB_*\n\n";
        exit(1);
    }

    return [
        'driver' => $driver,
        'host' => $host,
        'port' => $port,
        'database' => $database,
        'username' => $username,
        'password' => $password
    ];
}

// Crear conexión PDO
function createConnection(array $config): PDO {
    try {
        $dsn = "{$config['driver']}:host={$config['host']};port={$config['port']};dbname={$config['database']}";

        if ($config['driver'] === 'mysql') {
            $dsn .= ";charset=utf8mb4";
        }

        $options = [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES => false,
        ];

        $pdo = new PDO($dsn, $config['username'], $config['password'], $options);

        echo Colors::GREEN . "✓ Conectado a: {$config['driver']}://{$config['host']}:{$config['port']}/{$config['database']}\n" . Colors::RESET;
        echo "\n";

        return $pdo;

    } catch (PDOException $e) {
        echo Colors::RED . "✗ Error de conexión: " . $e->getMessage() . "\n" . Colors::RESET;
        echo "\nVerifica tu configuración en .env:\n";
        echo "  DB_HOST={$config['host']}\n";
        echo "  DB_PORT={$config['port']}\n";
        echo "  DB_DATABASE={$config['database']}\n";
        echo "  DB_USERNAME={$config['username']}\n";
        echo "  DB_PASSWORD=****\n\n";
        exit(1);
    }
}

// Parsear argumentos
function parseArgs(array $argv): array {
    $args = [
        'command' => 'migrate',
        'options' => []
    ];

    for ($i = 1; $i < count($argv); $i++) {
        $arg = $argv[$i];

        if (strpos($arg, '--') === 0) {
            // Opción larga: --key=value
            $parts = explode('=', substr($arg, 2), 2);
            $key = $parts[0];
            $value = $parts[1] ?? true;
            $args['options'][$key] = $value;
        } elseif (strpos($arg, '-') === 0) {
            // Opción corta: -v
            $args['options'][substr($arg, 1)] = true;
        } else {
            // Comando
            $args['command'] = $arg;
        }
    }

    return $args;
}

// Mostrar ayuda
function showHelp() {
    echo "Uso: php migrate [comando] [opciones]\n\n";

    echo Colors::BOLD . "Comandos disponibles:\n" . Colors::RESET;
    echo "  " . Colors::GREEN . "migrate" . Colors::RESET . "           Ejecutar todas las migraciones pendientes (por defecto)\n";
    echo "  " . Colors::GREEN . "status" . Colors::RESET . "            Mostrar el estado de las migraciones\n";
    echo "  " . Colors::GREEN . "rollback" . Colors::RESET . "          Revertir la última batch de migraciones\n";
    echo "  " . Colors::GREEN . "fresh" . Colors::RESET . "             Eliminar todas las tablas y ejecutar migraciones\n";
    echo "  " . Colors::GREEN . "reset" . Colors::RESET . "             Revertir todas las migraciones\n";
    echo "  " . Colors::GREEN . "seed" . Colors::RESET . "              Ejecutar solo los seeders de datos\n";
    echo "  " . Colors::GREEN . "help" . Colors::RESET . "              Mostrar esta ayuda\n";

    echo "\n" . Colors::BOLD . "Opciones:\n" . Colors::RESET;
    echo "  " . Colors::CYAN . "--module=nombre" . Colors::RESET . "   Ejecutar solo migraciones de un módulo específico\n";
    echo "  " . Colors::CYAN . "--seed" . Colors::RESET . "             Ejecutar seeders después de migrar\n";
    echo "  " . Colors::CYAN . "--force" . Colors::RESET . "            Forzar ejecución sin confirmación\n";
    echo "  " . Colors::CYAN . "--quiet" . Colors::RESET . "            No mostrar output detallado\n";

    echo "\n" . Colors::BOLD . "Ejemplos:\n" . Colors::RESET;
    echo "  php migrate\n";
    echo "  php migrate status\n";
    echo "  php migrate fresh --seed\n";
    echo "  php migrate seed\n";
    echo "  php migrate --module=MediaManager\n";
    echo "\n";
}

// Comando: Ejecutar seeders
function runSeeders() {
    echo Colors::BOLD . "\nEjecutando Seeders...\n" . Colors::RESET;
    echo str_repeat('─', 50) . "\n";

    $seederFile = APP_ROOT . '/database/seeders/DatabaseSeeder.php';

    if (!file_exists($seederFile)) {
        echo Colors::RED . "✗ No se encontró DatabaseSeeder.php\n" . Colors::RESET;
        return false;
    }

    require_once $seederFile;

    // Cargar todos los seeders
    $seedersDir = APP_ROOT . '/database/seeders';
    foreach (glob($seedersDir . '/*.php') as $file) {
        require_once $file;
    }

    try {
        $seeder = new \Screenart\Musedock\Database\Seeders\DatabaseSeeder();
        $seeder->run();
        echo Colors::GREEN . "✓ Seeders ejecutados correctamente\n" . Colors::RESET;
        return true;
    } catch (Exception $e) {
        echo Colors::RED . "✗ Error en seeders: " . $e->getMessage() . "\n" . Colors::RESET;
        return false;
    }
}

// Comando: Status
function commandStatus(MigrationManager $manager) {
    echo Colors::BOLD . "Estado de las Migraciones:\n" . Colors::RESET;
    echo str_repeat('─', 50) . "\n";

    $status = $manager->status();

    echo "Total: " . Colors::CYAN . $status['total'] . Colors::RESET . " | ";
    echo "Ejecutadas: " . Colors::GREEN . $status['executed'] . Colors::RESET . " | ";
    echo "Pendientes: " . Colors::YELLOW . $status['pending'] . Colors::RESET . "\n\n";

    if (empty($status['migrations'])) {
        echo "No se encontraron archivos de migración.\n";
        return;
    }

    foreach ($status['migrations'] as $migration) {
        $icon = $migration['status'] === 'executed' ? Colors::GREEN . '✓' : Colors::YELLOW . '○';
        $status_text = $migration['status'] === 'executed' ? 'Ejecutada' : 'Pendiente';
        $color = $migration['status'] === 'executed' ? Colors::GREEN : Colors::YELLOW;

        echo $icon . Colors::RESET . " ";
        echo $migration['name'];
        echo " " . Colors::RESET . "(" . $color . $status_text . Colors::RESET . ")\n";
    }

    echo "\n";
}

// Comando: Fresh (peligroso, pide confirmación)
function commandFresh(MigrationManager $manager, bool $force = false) {
    if (!$force) {
        echo Colors::RED . Colors::BOLD;
        echo "⚠ ADVERTENCIA: Esto eliminará TODAS las tablas de la base de datos\n";
        echo Colors::RESET;
        echo "¿Estás seguro? Escribe 'yes' para confirmar: ";

        $handle = fopen("php://stdin", "r");
        $line = trim(fgets($handle));
        fclose($handle);

        if ($line !== 'yes') {
            echo Colors::YELLOW . "Operación cancelada.\n" . Colors::RESET;
            return;
        }
    }

    echo Colors::YELLOW . "\nEliminando todas las migraciones...\n" . Colors::RESET;

    // Aquí se implementaría la lógica de fresh
    // Por seguridad, no la implementamos por defecto

    echo Colors::YELLOW . "Comando 'fresh' no implementado por seguridad.\n";
    echo "Usa rollback o elimina manualmente las tablas.\n" . Colors::RESET;
}

// ============================================
// MAIN
// ============================================

showBanner();

// Parsear argumentos
$args = parseArgs($argv);
$command = $args['command'];
$options = $args['options'];

// Mostrar ayuda
if ($command === 'help' || isset($options['help']) || isset($options['h'])) {
    showHelp();
    exit(0);
}

// Configuración
echo Colors::BOLD . "Leyendo configuración desde .env...\n" . Colors::RESET;
$config = getDatabaseConfig();

// Conectar
$pdo = createConnection($config);

// Crear manager
$migrationsPath = APP_ROOT . '/database/migrations';
$manager = new MigrationManager($pdo, $migrationsPath, $config['driver']);

// Quiet mode
if (isset($options['quiet']) || isset($options['q'])) {
    $manager->setVerbose(false);
}

// Módulo específico
$modulePath = null;
if (isset($options['module'])) {
    $modulePath = APP_ROOT . '/modules/' . $options['module'] . '/migrations';
    echo Colors::CYAN . "Ejecutando solo migraciones del módulo: {$options['module']}\n" . Colors::RESET;
    echo "\n";
}

// Ejecutar comando
try {
    switch ($command) {
        case 'status':
            commandStatus($manager);
            break;

        case 'rollback':
            echo Colors::BOLD . "Revirtiendo última batch...\n" . Colors::RESET;
            echo str_repeat('─', 50) . "\n";
            $result = $manager->rollback();
            echo "\n" . ($result['success'] ? Colors::GREEN : Colors::RED);
            echo $result['message'] . Colors::RESET . "\n";
            break;

        case 'fresh':
            commandFresh($manager, isset($options['force']));
            // Si tiene --seed, ejecutar seeders después
            if (isset($options['seed'])) {
                runSeeders();
            }
            break;

        case 'reset':
            echo Colors::YELLOW . "Revirtiendo todas las migraciones...\n" . Colors::RESET;
            while (true) {
                $result = $manager->rollback();
                if ($result['rolled_back'] === 0) {
                    break;
                }
            }
            echo Colors::GREEN . "✓ Todas las migraciones revertidas\n" . Colors::RESET;
            break;

        case 'seed':
            // Solo ejecutar seeders
            runSeeders();
            break;

        case 'migrate':
        default:
            echo Colors::BOLD . "Ejecutando migraciones...\n" . Colors::RESET;
            echo str_repeat('─', 50) . "\n";
            $result = $manager->migrate($modulePath);
            echo "\n";

            if ($result['success']) {
                echo Colors::GREEN . Colors::BOLD . "✓ " . $result['message'] . Colors::RESET . "\n";

                // Si tiene --seed, ejecutar seeders después
                if (isset($options['seed'])) {
                    runSeeders();
                }
            } else {
                echo Colors::RED . Colors::BOLD . "✗ " . $result['message'] . Colors::RESET . "\n";
                exit(1);
            }
            break;
    }

} catch (Exception $e) {
    echo Colors::RED . "\n✗ Error: " . $e->getMessage() . "\n" . Colors::RESET;
    exit(1);
}

echo "\n";
exit(0);
