<?php
/**
 * Migration: Add verification_email_sent_count to customers table
 * Generated by MuseDock - Customer Email Tracking
 * Compatible with: MySQL/MariaDB + PostgreSQL
 *
 * Adds counter to track how many verification emails have been sent to a customer
 */

use Screenart\Musedock\Database;

class AddVerificationEmailSentCountToCustomers_2025_12_17_120000
{
    public function up()
    {
        $pdo = Database::connect();
        $driver = $pdo->getAttribute(PDO::ATTR_DRIVER_NAME);

        try {
            if ($driver === 'mysql') {
                // Check if column already exists
                $stmt = $pdo->query("
                    SELECT COUNT(*) as count
                    FROM information_schema.COLUMNS
                    WHERE TABLE_SCHEMA = DATABASE()
                    AND TABLE_NAME = 'customers'
                    AND COLUMN_NAME = 'verification_email_sent_count'
                ");
                $result = $stmt->fetch(PDO::FETCH_ASSOC);

                if ($result['count'] == 0) {
                    $pdo->exec("
                        ALTER TABLE `customers`
                        ADD COLUMN `verification_email_sent_count` INT UNSIGNED NOT NULL DEFAULT 0
                        COMMENT 'Number of verification emails sent'
                        AFTER `email_verified_at`
                    ");
                    echo "✓ Column verification_email_sent_count added to customers table (MySQL)\n";
                } else {
                    echo "→ Column verification_email_sent_count already exists in customers table (MySQL)\n";
                }
            } else {
                // PostgreSQL
                // Check if column already exists
                $stmt = $pdo->query("
                    SELECT COUNT(*) as count
                    FROM information_schema.columns
                    WHERE table_schema = 'public'
                    AND table_name = 'customers'
                    AND column_name = 'verification_email_sent_count'
                ");
                $result = $stmt->fetch(PDO::FETCH_ASSOC);

                if ($result['count'] == 0) {
                    $pdo->exec("
                        ALTER TABLE customers
                        ADD COLUMN verification_email_sent_count INT NOT NULL DEFAULT 0
                    ");

                    $pdo->exec("
                        COMMENT ON COLUMN customers.verification_email_sent_count
                        IS 'Number of verification emails sent'
                    ");

                    echo "✓ Column verification_email_sent_count added to customers table (PostgreSQL)\n";
                } else {
                    echo "→ Column verification_email_sent_count already exists in customers table (PostgreSQL)\n";
                }
            }
        } catch (PDOException $e) {
            echo "✗ Error adding column verification_email_sent_count: " . $e->getMessage() . "\n";
            throw $e;
        }
    }

    public function down()
    {
        $pdo = Database::connect();
        $driver = $pdo->getAttribute(PDO::ATTR_DRIVER_NAME);

        try {
            if ($driver === 'mysql') {
                // Check if column exists before dropping
                $stmt = $pdo->query("
                    SELECT COUNT(*) as count
                    FROM information_schema.COLUMNS
                    WHERE TABLE_SCHEMA = DATABASE()
                    AND TABLE_NAME = 'customers'
                    AND COLUMN_NAME = 'verification_email_sent_count'
                ");
                $result = $stmt->fetch(PDO::FETCH_ASSOC);

                if ($result['count'] > 0) {
                    $pdo->exec("ALTER TABLE `customers` DROP COLUMN `verification_email_sent_count`");
                    echo "✓ Column verification_email_sent_count dropped from customers table (MySQL)\n";
                } else {
                    echo "→ Column verification_email_sent_count does not exist in customers table (MySQL)\n";
                }
            } else {
                // PostgreSQL
                // Check if column exists before dropping
                $stmt = $pdo->query("
                    SELECT COUNT(*) as count
                    FROM information_schema.columns
                    WHERE table_schema = 'public'
                    AND table_name = 'customers'
                    AND column_name = 'verification_email_sent_count'
                ");
                $result = $stmt->fetch(PDO::FETCH_ASSOC);

                if ($result['count'] > 0) {
                    $pdo->exec("ALTER TABLE customers DROP COLUMN verification_email_sent_count");
                    echo "✓ Column verification_email_sent_count dropped from customers table (PostgreSQL)\n";
                } else {
                    echo "→ Column verification_email_sent_count does not exist in customers table (PostgreSQL)\n";
                }
            }
        } catch (PDOException $e) {
            echo "✗ Error dropping column verification_email_sent_count: " . $e->getMessage() . "\n";
            throw $e;
        }
    }
}
