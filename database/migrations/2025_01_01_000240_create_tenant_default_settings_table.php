<?php
/**
 * Migration: Create tenant_default_settings table
 * Generated by MuseDock Dual Migration Generator
 * Generated at: 2025_12_11_120000
 * Compatible with: MySQL/MariaDB + PostgreSQL
 */

use Screenart\Musedock\Database;

class CreateTenantDefaultSettingsTable_2025_12_11_120000
{
    public function up()
    {
        $pdo = Database::connect();
        $driver = $pdo->getAttribute(PDO::ATTR_DRIVER_NAME);

        if ($driver === 'mysql') {
            $pdo->exec("
                CREATE TABLE `tenant_default_settings` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `setting_key` varchar(100) NOT NULL,
  `setting_value` text DEFAULT NULL,
  `setting_type` enum('json','string','boolean','integer') NOT NULL DEFAULT 'string',
  `description` varchar(255) DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_setting_key` (`setting_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ");

            // Insert default settings
            $this->insertDefaultSettings($pdo);
        } else {
            // PostgreSQL
            $pdo->exec("
                CREATE TABLE tenant_default_settings (
  id SERIAL PRIMARY KEY,
  setting_key VARCHAR(100) NOT NULL UNIQUE,
  setting_value TEXT,
  setting_type VARCHAR(20) NOT NULL DEFAULT 'string',
  description VARCHAR(255),
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CHECK (setting_type IN ('json', 'string', 'boolean', 'integer'))
)
            ");

            // Create trigger for updated_at
            $pdo->exec("
                CREATE OR REPLACE FUNCTION update_tenant_default_settings_updated_at()
                RETURNS TRIGGER AS \$\$
                BEGIN
                    NEW.updated_at = CURRENT_TIMESTAMP;
                    RETURN NEW;
                END;
                \$\$ language 'plpgsql';
            ");

            $pdo->exec("
                CREATE TRIGGER update_tenant_default_settings_updated_at
                BEFORE UPDATE ON tenant_default_settings
                FOR EACH ROW
                EXECUTE FUNCTION update_tenant_default_settings_updated_at();
            ");

            // Insert default settings
            $this->insertDefaultSettings($pdo);
        }

        echo "✓ Table tenant_default_settings created\n";
    }

    private function insertDefaultSettings(PDO $pdo)
    {
        // IMPORTANTE: Los slugs deben coincidir con los de la tabla permissions (tenant_id IS NULL)
        // La única fuente de verdad son los permisos globales en la tabla permissions
        $defaultPermissions = json_encode([
            // Páginas
            'pages.view', 'pages.create', 'pages.edit', 'pages.delete',
            // Blog
            'blog.view', 'blog.create', 'blog.edit', 'blog.delete', 'blog.edit.all',
            // Usuarios y configuración
            'users.manage', 'settings.view', 'settings.edit',
            // Apariencia
            'appearance.menus', 'appearance.themes',
            // Módulos y media
            'modules.manage', 'media.manage', 'languages.manage',
            // Logs y tickets
            'logs.view', 'tickets.manage',
            // Formularios
            'custom_forms.view', 'custom_forms.create', 'custom_forms.edit', 'custom_forms.delete',
            'custom_forms.submissions.view', 'custom_forms.submissions.export', 'custom_forms.submissions.delete',
            // Galería de imágenes
            'image_gallery.view', 'image_gallery.create', 'image_gallery.edit', 'image_gallery.delete',
            // Sliders React
            'react_sliders.view', 'react_sliders.create', 'react_sliders.edit', 'react_sliders.delete',
            // Avanzado
            'advanced.ai', 'advanced.cron', 'analytics-view', 'analytics-export'
        ]);

        $defaultRoles = json_encode([
            ['name' => 'Admin', 'slug' => 'admin', 'description' => 'Administrador del tenant con acceso completo'],
            ['name' => 'Editor', 'slug' => 'editor', 'description' => 'Editor de contenido'],
            ['name' => 'Viewer', 'slug' => 'viewer', 'description' => 'Solo lectura']
        ]);

        $settings = [
            [
                'setting_key' => 'default_permissions',
                'setting_value' => $defaultPermissions,
                'setting_type' => 'json',
                'description' => 'Permisos que se asignan al rol Admin por defecto'
            ],
            [
                'setting_key' => 'default_roles',
                'setting_value' => $defaultRoles,
                'setting_type' => 'json',
                'description' => 'Roles que se crean por defecto para cada tenant'
            ],
            [
                'setting_key' => 'copy_menus_from_admin',
                'setting_value' => '1',
                'setting_type' => 'boolean',
                'description' => 'Copiar menús desde admin_menus al crear tenant'
            ],
            [
                'setting_key' => 'default_theme',
                'setting_value' => 'default',
                'setting_type' => 'string',
                'description' => 'Tema por defecto para nuevos tenants'
            ],
            [
                'setting_key' => 'assign_admin_role_to_creator',
                'setting_value' => '1',
                'setting_type' => 'boolean',
                'description' => 'Asignar rol Admin al usuario creador del tenant'
            ]
        ];

        $stmt = $pdo->prepare("
            INSERT INTO tenant_default_settings (setting_key, setting_value, setting_type, description)
            VALUES (:setting_key, :setting_value, :setting_type, :description)
        ");

        foreach ($settings as $setting) {
            $stmt->execute($setting);
        }
    }

    public function down()
    {
        $pdo = Database::connect();
        $driver = $pdo->getAttribute(PDO::ATTR_DRIVER_NAME);

        if ($driver === 'mysql') {
            $pdo->exec("DROP TABLE IF EXISTS `tenant_default_settings`");
        } else {
            $pdo->exec("DROP TRIGGER IF EXISTS update_tenant_default_settings_updated_at ON tenant_default_settings");
            $pdo->exec("DROP FUNCTION IF EXISTS update_tenant_default_settings_updated_at()");
            $pdo->exec("DROP TABLE IF EXISTS tenant_default_settings");
        }

        echo "✓ Table tenant_default_settings dropped\n";
    }
}
