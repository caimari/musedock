<?php
/**
 * Migration: Create customer_session_tokens table
 * Generated by MuseDock - Customer Registration System
 * Compatible with: MySQL/MariaDB + PostgreSQL
 *
 * Tabla para remember me tokens de customers
 * Soporta rotación de tokens para seguridad mejorada
 */

use Screenart\Musedock\Database;

class CreateCustomerSessionTokensTable_2025_01_01_000244
{
    public function up()
    {
        $pdo = Database::connect();
        $driver = $pdo->getAttribute(PDO::ATTR_DRIVER_NAME);

        if ($driver === 'mysql') {
            $pdo->exec("
                CREATE TABLE IF NOT EXISTS `customer_session_tokens` (
                    `id` INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
                    `customer_id` INT UNSIGNED NOT NULL,

                    -- Token storage (SHA-256 hash)
                    `token` VARCHAR(255) NOT NULL UNIQUE COMMENT 'SHA-256 hash of token',

                    -- Security tracking
                    `ip` VARCHAR(45) NULL COMMENT 'IPv4 or IPv6',
                    `user_agent` TEXT NULL,
                    `persistent` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'Remember me enabled',

                    -- Lifecycle
                    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    `expires_at` TIMESTAMP NOT NULL,
                    `last_used_at` TIMESTAMP NULL,

                    -- Foreign Key constraint
                    CONSTRAINT `fk_customer_session_tokens_customer`
                        FOREIGN KEY (`customer_id`)
                        REFERENCES `customers`(`id`)
                        ON DELETE CASCADE,

                    -- Indexes for performance
                    UNIQUE INDEX `idx_token` (`token`),
                    INDEX `idx_customer_id` (`customer_id`),
                    INDEX `idx_expires_at` (`expires_at`),
                    INDEX `idx_last_used_at` (`last_used_at`)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ");
        } else {
            // PostgreSQL
            $pdo->exec("
                CREATE TABLE IF NOT EXISTS customer_session_tokens (
                    id SERIAL PRIMARY KEY,
                    customer_id INT NOT NULL,

                    -- Token storage (SHA-256 hash)
                    token VARCHAR(255) NOT NULL UNIQUE,

                    -- Security tracking
                    ip VARCHAR(45) NULL,
                    user_agent TEXT NULL,
                    persistent BOOLEAN NOT NULL DEFAULT TRUE,

                    -- Lifecycle
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    expires_at TIMESTAMP NOT NULL,
                    last_used_at TIMESTAMP NULL,

                    -- Foreign Key constraint
                    CONSTRAINT fk_customer_session_tokens_customer
                        FOREIGN KEY (customer_id)
                        REFERENCES customers(id)
                        ON DELETE CASCADE
                )
            ");

            // Create indexes
            $pdo->exec("CREATE UNIQUE INDEX IF NOT EXISTS idx_customer_session_tokens_token ON customer_session_tokens(token)");
            $pdo->exec("CREATE INDEX IF NOT EXISTS idx_customer_session_tokens_customer_id ON customer_session_tokens(customer_id)");
            $pdo->exec("CREATE INDEX IF NOT EXISTS idx_customer_session_tokens_expires_at ON customer_session_tokens(expires_at)");
            $pdo->exec("CREATE INDEX IF NOT EXISTS idx_customer_session_tokens_last_used_at ON customer_session_tokens(last_used_at)");
        }

        echo "✓ Table customer_session_tokens created\n";
    }

    public function down()
    {
        $pdo = Database::connect();
        $pdo->exec("DROP TABLE IF EXISTS customer_session_tokens");
        echo "✓ Table customer_session_tokens dropped\n";
    }
}
