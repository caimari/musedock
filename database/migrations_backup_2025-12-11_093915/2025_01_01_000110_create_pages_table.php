<?php
/**
 * Migration: Create pages table
 * Generated by MuseDock Dual Migration Generator
 * Generated at: 2025_12_11_091120
 * Compatible with: MySQL/MariaDB + PostgreSQL
 */

use Screenart\Musedock\Database;

class CreatePagesTable_2025_12_11_091120
{
    public function up()
    {
        $pdo = Database::connect();
        $driver = $pdo->getAttribute(PDO::ATTR_DRIVER_NAME);

        if ($driver === 'mysql') {
            $pdo->exec("
                CREATE TABLE `pages` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `tenant_id` int(11) DEFAULT NULL,
  `user_id` int(11) DEFAULT NULL,
  `user_type` enum('admin','superadmin') DEFAULT 'admin',
  `base_locale` varchar(5) DEFAULT 'es',
  `title` varchar(255) NOT NULL,
  `slug` varchar(255) NOT NULL,
  `content` text DEFAULT NULL,
  `seo_title` varchar(255) DEFAULT NULL,
  `seo_description` text DEFAULT NULL,
  `seo_keywords` varchar(255) DEFAULT NULL,
  `seo_image` varchar(255) DEFAULT NULL,
  `canonical_url` varchar(255) DEFAULT NULL,
  `robots_directive` varchar(50) DEFAULT 'index,follow',
  `twitter_title` varchar(255) DEFAULT NULL,
  `twitter_description` text DEFAULT NULL,
  `twitter_image` varchar(255) DEFAULT NULL,
  `status` enum('draft','published','trash') DEFAULT 'draft',
  `is_homepage` tinyint(1) unsigned NOT NULL DEFAULT '0',
  `show_slider` tinyint(1) DEFAULT '0' COMMENT 'Indica si se debe mostrar el slider',
  `slider_image` varchar(255) DEFAULT NULL COMMENT 'Ruta a la imagen del slider',
  `slider_title` varchar(255) DEFAULT NULL COMMENT 'Título personalizado para el slider',
  `slider_content` text DEFAULT NULL COMMENT 'Contenido HTML para el slider',
  `hide_title` tinyint(1) DEFAULT '0' COMMENT 'Ocultar el título H1 en la página',
  `published_at` datetime DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `visibility` enum('public','private','members') NOT NULL DEFAULT 'public',
  `revision_count` int(11) DEFAULT '0' COMMENT 'Contador de revisiones (cache)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `slug` (`slug`),
  KEY `idx_is_homepage` (`is_homepage`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ");
        } else {
            // PostgreSQL
            $pdo->exec("
                CREATE TABLE pages (
  id SERIAL PRIMARY KEY,
  tenant_id INTEGER,
  user_id INTEGER,
  user_type VARCHAR(20) DEFAULT 'admin',
  base_locale VARCHAR(5) DEFAULT 'es',
  title VARCHAR(255) NOT NULL,
  slug VARCHAR(255) NOT NULL,
  content TEXT,
  seo_title VARCHAR(255),
  seo_description TEXT,
  seo_keywords VARCHAR(255),
  seo_image VARCHAR(255),
  canonical_url VARCHAR(255),
  robots_directive VARCHAR(50) DEFAULT 'index,follow',
  twitter_title VARCHAR(255),
  twitter_description TEXT,
  twitter_image VARCHAR(255),
  status VARCHAR(20) DEFAULT 'draft',
  is_homepage SMALLINT NOT NULL DEFAULT '0',
  show_slider SMALLINT DEFAULT '0',
  slider_image VARCHAR(255),
  slider_title VARCHAR(255),
  slider_content TEXT,
  hide_title SMALLINT DEFAULT '0',
  published_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  visibility VARCHAR(20) NOT NULL DEFAULT 'public',
  revision_count INTEGER DEFAULT '0',
  CHECK (user_type IN ('admin', 'superadmin')),
  CHECK (status IN ('draft', 'published', 'trash')),
  CHECK (visibility IN ('public', 'private', 'members')),
  UNIQUE (slug)
)
            ");

            // Create indexes
            $pdo->exec("CREATE INDEX idx_is_homepage ON pages(is_homepage)");

            // Add comments
            $pdo->exec("COMMENT ON COLUMN pages.show_slider IS 'Indica si se debe mostrar el slider'");
            $pdo->exec("COMMENT ON COLUMN pages.slider_image IS 'Ruta a la imagen del slider'");
            $pdo->exec("COMMENT ON COLUMN pages.slider_title IS 'Título personalizado para el slider'");
            $pdo->exec("COMMENT ON COLUMN pages.slider_content IS 'Contenido HTML para el slider'");
            $pdo->exec("COMMENT ON COLUMN pages.hide_title IS 'Ocultar el título H1 en la página'");
            $pdo->exec("COMMENT ON COLUMN pages.revision_count IS 'Contador de revisiones (cache)'");
        }

        echo "✓ Table pages created\n";
    }

    public function down()
    {
        $pdo = Database::connect();
        $driver = $pdo->getAttribute(PDO::ATTR_DRIVER_NAME);

        if ($driver === 'mysql') {
            $pdo->exec("DROP TABLE IF EXISTS `pages`");
        } else {
            $pdo->exec("DROP TABLE IF EXISTS pages");
        }

        echo "✓ Table pages dropped\n";
    }
}
